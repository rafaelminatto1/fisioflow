#!/bin/sh
# Pre-commit hook para FisioFlow
# Executa verificaÃ§Ãµes antes de cada commit

set -e

echo "ğŸ” Executando verificaÃ§Ãµes pre-commit..."

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# FunÃ§Ã£o para imprimir com cor
print_color() {
    printf "${1}${2}${NC}\n"
}

# Verificar se hÃ¡ arquivos staged
if git diff --cached --quiet; then
    print_color $YELLOW "âš ï¸  Nenhum arquivo staged para commit"
    exit 1
fi

# Verificar se hÃ¡ arquivos grandes (>5MB)
print_color $BLUE "ğŸ“ Verificando tamanho dos arquivos..."
large_files=$(git diff --cached --name-only | xargs -I {} find {} -size +5M 2>/dev/null || true)
if [ ! -z "$large_files" ]; then
    print_color $RED "âŒ Arquivos muito grandes encontrados (>5MB):"
    echo "$large_files"
    print_color $YELLOW "ğŸ’¡ Considere usar Git LFS para arquivos grandes"
    exit 1
fi

# Verificar se hÃ¡ secrets ou chaves
print_color $BLUE "ğŸ”’ Verificando secrets..."
secret_patterns=(
    "password\s*=\s*['\"][^'\"]+['\"]" 
    "api[_-]?key\s*=\s*['\"][^'\"]+['\"]" 
    "secret\s*=\s*['\"][^'\"]+['\"]" 
    "-----BEGIN.*PRIVATE.*KEY-----" 
    "sk_live_" 
    "pk_live_" 
    "AIza[0-9A-Za-z\\-_]{35}"
)

for pattern in "${secret_patterns[@]}"; do
    # Excluir arquivos de hook da verificaÃ§Ã£o de secrets
    staged_content=$(git diff --cached --name-only | grep -v "\.githooks/" | xargs git diff --cached 2>/dev/null || true)
    if echo "$staged_content" | grep -iE "$pattern" >/dev/null 2>&1; then
        # Verificar se nÃ£o Ã© um caso legÃ­timo (mock tokens ou enums)
        if ! echo "$staged_content" | grep -q "mock-token" && ! echo "$staged_content" | grep -q "SMS_TOKEN = 'sms_token'"; then
            print_color $RED "âŒ PossÃ­vel secret detectado no commit!"
            print_color $YELLOW "ğŸ” PadrÃ£o encontrado: $pattern"
            print_color $YELLOW "ğŸ’¡ Remova secrets antes de fazer commit"
            exit 1
        fi
    fi
done

# Verificar arquivos TypeScript/JavaScript
print_color $BLUE "ğŸ”§ Verificando arquivos TS/JS..."
ts_js_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$' || true)

if [ ! -z "$ts_js_files" ]; then
    # Verificar sintaxe bÃ¡sica
    for file in $ts_js_files; do
        if [ -f "$file" ]; then
            # Verificar se hÃ¡ console.log em produÃ§Ã£o
            if grep -n "console\.log" "$file" >/dev/null 2>&1; then
                print_color $YELLOW "âš ï¸  console.log encontrado em $file"
                print_color $YELLOW "ğŸ’¡ Considere remover antes do commit"
            fi
            
            # Verificar se hÃ¡ debugger (excluindo configuraÃ§Ãµes legÃ­timas)
            if grep -n "debugger" "$file" | grep -v "drop_debugger" >/dev/null 2>&1; then
                print_color $RED "âŒ debugger encontrado em $file"
                print_color $YELLOW "ğŸ’¡ Remova debugger antes do commit"
                exit 1
            fi
            
            # Verificar se hÃ¡ TODO/FIXME
            if grep -n "TODO\|FIXME" "$file" >/dev/null 2>&1; then
                print_color $YELLOW "ğŸ“ TODO/FIXME encontrado em $file"
            fi
        fi
    done
    
    # Executar ESLint se disponÃ­vel
    if command -v npx >/dev/null 2>&1 && [ -f "package.json" ]; then
        if npm list eslint >/dev/null 2>&1; then
            print_color $BLUE "ğŸ” Executando ESLint..."
            if ! npx eslint $ts_js_files --max-warnings 0; then
                print_color $RED "âŒ ESLint falhou"
                print_color $YELLOW "ğŸ’¡ Corrija os erros de linting antes do commit"
                exit 1
            fi
        fi
    fi
fi

# Verificar arquivos de configuraÃ§Ã£o
print_color $BLUE "âš™ï¸  Verificando arquivos de configuraÃ§Ã£o..."
config_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(json|yml|yaml|toml)$' || true)

if [ ! -z "$config_files" ]; then
    for file in $config_files; do
        if [ -f "$file" ]; then
            case "$file" in
                *.json)
                    if ! python -m json.tool "$file" >/dev/null 2>&1 && ! node -e "JSON.parse(require('fs').readFileSync('$file', 'utf8'))" >/dev/null 2>&1; then
                        print_color $RED "âŒ JSON invÃ¡lido em $file"
                        exit 1
                    fi
                    ;;
                *.yml|*.yaml)
                    if command -v yamllint >/dev/null 2>&1; then
                        if ! yamllint "$file" >/dev/null 2>&1; then
                            print_color $YELLOW "âš ï¸  PossÃ­vel problema no YAML: $file"
                        fi
                    fi
                    ;;
            esac
        fi
    done
fi

# Verificar se hÃ¡ conflitos de merge nÃ£o resolvidos
print_color $BLUE "ğŸ”€ Verificando conflitos de merge..."
if git diff --cached | grep -E '^(<{7}|={7}|>{7})' >/dev/null 2>&1; then
    print_color $RED "âŒ Marcadores de conflito de merge encontrados!"
    print_color $YELLOW "ğŸ’¡ Resolva todos os conflitos antes do commit"
    exit 1
fi

# Verificar se hÃ¡ whitespace issues
print_color $BLUE "ğŸ§¹ Verificando whitespace..."
if ! git diff --cached --check >/dev/null 2>&1; then
    print_color $YELLOW "âš ï¸  Problemas de whitespace encontrados"
    print_color $YELLOW "ğŸ’¡ Execute 'git diff --cached --check' para detalhes"
fi

# Verificar tamanho do commit
print_color $BLUE "ğŸ“Š Verificando tamanho do commit..."
files_changed=$(git diff --cached --numstat | wc -l)
lines_added=$(git diff --cached --numstat | awk '{sum += $1} END {print sum+0}')
lines_deleted=$(git diff --cached --numstat | awk '{sum += $2} END {print sum+0}')

if [ "$files_changed" -gt 50 ]; then
    print_color $YELLOW "âš ï¸  Muitos arquivos alterados ($files_changed)"
    print_color $YELLOW "ğŸ’¡ Considere dividir em commits menores"
fi

if [ "$lines_added" -gt 1000 ]; then
    print_color $YELLOW "âš ï¸  Muitas linhas adicionadas ($lines_added)"
    print_color $YELLOW "ğŸ’¡ Considere dividir em commits menores"
fi

# Verificar se hÃ¡ package-lock.json e package.json juntos
if git diff --cached --name-only | grep -q "package.json" && git diff --cached --name-only | grep -q "package-lock.json"; then
    print_color $GREEN "âœ… package.json e package-lock.json atualizados juntos"
elif git diff --cached --name-only | grep -q "package.json"; then
    print_color $YELLOW "âš ï¸  package.json alterado sem package-lock.json"
    print_color $YELLOW "ğŸ’¡ Execute 'npm install' para atualizar o lock file"
fi

print_color $GREEN "âœ… Todas as verificaÃ§Ãµes pre-commit passaram!"
print_color $BLUE "ğŸ“ Arquivos: $files_changed | Linhas: +$lines_added -$lines_deleted"

exit 0