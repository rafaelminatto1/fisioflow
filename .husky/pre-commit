#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Pre-commit hook otimizado para FisioFlow
echo "ğŸ” Executando verificaÃ§Ãµes pre-commit..."

# 1. Lint-staged (jÃ¡ configurado no package.json)
npx lint-staged

# 2. Verificar se hÃ¡ arquivos grandes (>10MB)
echo "ğŸ“ Verificando tamanho dos arquivos..."
find . -type f -size +10M -not -path "./node_modules/*" -not -path "./.git/*" | while read file; do
  echo "âš ï¸  Arquivo grande detectado: $file"
  echo "ğŸ’¡ Considere usar Git LFS para arquivos grandes"
done

# 3. Verificar se hÃ¡ secrets/keys expostos
echo "ğŸ” Verificando por secrets expostos..."
if grep -r -i --exclude-dir=node_modules --exclude-dir=.git \
  -E "(api_key|secret|password|token)\s*=\s*['\"][^'\"]{8,}" . ; then
  echo "âŒ PossÃ­veis secrets detectados! Remova antes do commit."
  exit 1
fi

# 4. Verificar imports nÃ£o utilizados (TypeScript)
echo "ğŸ§¹ Verificando imports nÃ£o utilizados..."
npx tsc --noEmit --skipLibCheck

# 5. Verificar se todos os testes passam
echo "ğŸ§ª Executando testes..."
npm test -- --passWithNoTests --watchAll=false

if [ $? -ne 0 ]; then
  echo "âŒ Testes falharam! Corrija antes do commit."
  exit 1
fi

echo "âœ… Todas as verificaÃ§Ãµes passaram!"